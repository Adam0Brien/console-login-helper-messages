#!/bin/bash

set -e

GENERATED_MOTD="/run/fedora-user-messages.motd"
ANSI_LIGHT_RED='\033[1;31m'
ANSI_LIGHT_BLUE='\033[1;34m'
ANSI_NC='\033[0m'

source /usr/lib/os-release

print_added_users() {
	echo -e "\n---- available users"
	added_users=$(awk --field-separator ':' '{ print " ",$1 }' /etc/passwd)
	echo "${added_users}"
}

print_rpm_ostree_update_info() {
	# TODO: this should not print out if no other information in the if
	# conditions below is printed.
	echo -e "\n---- rpm-ostree"

	rpm-ostree status --json > /run/fedora-user-messages/rpm-ostree-status.json
	pending_deployment_exists=$(jq '.deployments[0].booted == false' /run/fedora-user-messages/rpm-ostree-status.json)
	if [ "${pending_deployment_exists}" = "true" ]; then
		echo -e "Deployment pending on next reboot"
	fi

	rpm-ostree upgrade --check > /run/fedora-user-messages/rpm-ostree-upgrade-check.out
	sec_advisories=$(cat /run/fedora-user-messages/rpm-ostree-upgrade-check.out | grep "SecAdvisories")
	pkg_diff=$(cat /run/fedora-user-messages/rpm-ostree-upgrade-check.out | grep "Diff")

	if [ -n "${sec_advisories}" ]; then
		sec_advisories=$(awk '{$1=""; sub(" ", " "); print}' <<< "${sec_advisories}")
		sec_advisories=$(echo "${sec_advisories}" | sed -e "s/^[[:space:]]*//")
		echo -e "${ANSI_LIGHT_RED}Security advisories:${ANSI_NC}"
		echo -e "  ${sec_advisories}"
	fi
	if [ -n "${pkg_diff}" ]; then
		num_upgrade=$(awk '{ print $2 }' <<< "${pkg_diff}")
		num_remove=$(awk '{ print $4 }' <<< "${pkg_diff}")
		num_add=$(awk '{ print $6 }' <<< "${pkg_diff}")
		echo -e "${ANSI_LIGHT_BLUE}Update available:${ANSI_NC}"
		echo "  ${num_upgrade} packages to upgrade"
		echo "  ${num_remove} packages to remove"
		echo "  ${num_add} new packages"
	fi
}

print_dnf_update_info() {
	echo -e "\n---- dnf"
	dnf -qC updateinfo > /run/fedora-user-messages/dnf-updateinfo.out
	cat /run/fedora-user-messages/dnf-updateinfo.out
}

mkdir -p /run/fedora-user-messages/motd.d

rm -f ${GENERATED_MOTD}

# Get updated system information and print it to the
# generated motd
echo -e "\e[${ANSI_COLOR}m${NAME}\e[39m (${VERSION})" > ${GENERATED_MOTD}

print_added_users >> ${GENERATED_MOTD}

if [ -x "$(command -v rpm-ostree)" ]; then
	set +e
	print_rpm_ostree_update_info >> ${GENERATED_MOTD}
	set -e
fi
if [ -x "$(command -v dnf)" ]; then
	set +e
	print_dnf_update_info >> ${GENERATED_MOTD}
	set -e
fi

# Look in directories where additional messages are dropped, append
# to the generated motd.
if [[ -d "/usr/lib/fedora-user-messages/motd.d" ]]; then
	cat /usr/lib/fedora-user-messages/motd.d/* 2>/dev/null >> $GENERATED_MOTD || true
fi
if [[ -d "/run/fedora-user-messages/motd.d" ]]; then
	cat /run/fedora-user-messages/motd.d/* 2>/dev/null >> $GENERATED_MOTD || true
fi
if [[ -d "/etc/fedora-user-messages/motd.d" ]]; then
	cat /etc/fedora-user-messages/motd.d/* 2>/dev/null >> $GENERATED_MOTD || true
fi
